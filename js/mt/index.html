<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
    <link rel="stylesheet" href="mixer.css"/>
</head>
<body>
<ul id="songs"></ul>
<template id="songlink">
    <li><a href="#HREF" class="switch">NAME</a></li>
</template>
<div class="mixer">
    <audio id="mc" controls controlsList="nodownload">
        <source type="audio/ogg">
    </audio>
    <div class="trackstrip"></div>
</div>
<template id="trackTemplate">
    <div class="track" data-track="TRACKNAME">
        <div class="label">
            <span class="name center">TRACKNAME</span>
        </div>
        <div class="button-container">
            <div class="mute-button">
                <label>
                    <input type="checkbox" value="1">
                    <span>M</span>
                </label>
            </div>
            <div class="solo-button">
                <label>
                    <input type="checkbox" value="1">
                    <span>S</span>
                </label>
            </div>
        </div>
        <div class="label">
            <span class="level right">0.00dB</span>
        </div>
        <div class="fader">
            <input type="range" min="0" max="1.0" step="any" value="0.787">
        </div>
    </div>
</template>
<script src="mixer.js"></script>
<script src="track.js"></script>
<script src="mixer-ui.js"></script>
<script>
    // Create an AudioContext:
    let ac = new AudioContext();

    // Create a mixer:
    let mixer = new Mixer();

    let xhr = new XMLHttpRequest();
    xhr.open('GET', 'mix.json', true);
    xhr.responseType = 'json';
    xhr.onload = function (e) {
        let mix = xhr.response;

        // Add default tracks to mixer:
        mixer.addTracks(mix.tracks);

        // Bind mixer to AudioContext:
        mixer.createNodes(ac);

        // Initialize mixer UI:
        new MixerUI(mixer).init();

        // Find our <audio> element:
        let mcAudio = document.getElementById("mc");
        let mcSource = ac.createMediaElementSource(mcAudio);
        mcSource.channelCountMode = "explicit";
        mcSource.channelInterpretation = "discrete";

        // TODO: would be nice to detect channel count from source.
        let splitter = ac.createChannelSplitter(8);
        try {
            // For older spec implementations:
            splitter.channelCountMode = "max";
        } catch (e) {
            splitter.channelCountMode = "explicit";
        }
        splitter.channelInterpretation = "discrete";
        mcSource.connect(splitter);

        // Split multichannel audio source into stereo/mono tracks:
        let c = 0;
        for (let track of mixer.tracks) {
            // Connect media output to track input:
            let merger = ac.createChannelMerger(2);
            merger.channelCountMode = "explicit";
            merger.channelInterpretation = "discrete";

            if (track.channels == 2) {
                // Assume stereo, so copy left/right channels independently:
                splitter.connect(merger, c++, 0);
                splitter.connect(merger, c++, 1);
            } else {
                // Assume mono, so copy single input channel to both output channels:
                splitter.connect(merger, c, 0);
                splitter.connect(merger, c, 1);
                c++;
            }
            merger.connect(track.inputNode);
        }

        // Create song links and wire up click handlers:
        let songsNode = document.getElementById("songs");
        let songlinkTemplate = document.getElementById('songlink');
        for (let song of mix.songs) {
            let node = document.importNode(songlinkTemplate.content, true);
            let a = node.querySelector("a");
            a.href = song;
            a.innerText = decodeURIComponent(song);
            a.addEventListener("click", e => {
                e.preventDefault();
                let href = e.target.getAttribute("href");
                mcAudio.src = href;
                mcAudio.play();
                return false;
            });
            songsNode.appendChild(node);
        }
    };
    xhr.send(null);

</script>
</body>
</html>